import{u as F,f as P,r as n,c as b,l as z,j as e,L as j}from"./index-BOyHK8Ne.js";import{h as y}from"./moment-C5S46NFB.js";const Y=()=>e.jsx("svg",{className:"w-5 h-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),W=()=>e.jsx("svg",{className:"w-6 h-6",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"})}),q=()=>e.jsx("svg",{className:"w-4 h-4 text-white ml-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),Q=()=>e.jsx("svg",{className:"w-24 h-24 text-gray-300 dark:text-gray-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),V=()=>e.jsx("svg",{className:"w-6 h-6",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z",clipRule:"evenodd"})}),K=()=>{const{user:o,token:h}=F(),{conversationId:f}=P(),[x,w]=n.useState([]),[a,N]=n.useState(null),[g,c]=n.useState([]),[m,k]=n.useState(""),[M,S]=n.useState(!0),[C,R]=n.useState(""),[I,U]=n.useState(new Map),[L,B]=n.useState(new Map),i=n.useRef(null),A=n.useRef(null),l=t=>!t?.participants||!o?null:t.participants.find(s=>s.id!==o.id),p=t=>t?.avatarUrl?t.avatarUrl.startsWith("http")?t.avatarUrl:`${b.defaults.baseURL}${t.avatarUrl}`.replace("/api",""):`https://ui-avatars.com/api/?name=${encodeURIComponent(t?.name||"User")}&background=random&color=fff`,E=n.useCallback(t=>{if(!t)return"";const s=y(),r=y(t);return s.diff(r,"minutes")<1?"just now":s.diff(r,"hours")<1?`${s.diff(r,"minutes")} min ago`:s.diff(r,"days")<1?r.format("h:mm A"):s.diff(r,"years")<1?r.format("MMM D"):r.format("MMM D, YYYY")},[]),v=n.useCallback(async t=>{if(a?.id!==t.id){N(t),c([]);try{const s=await b.get(`/messages/${t.id}`);c(s.data),i.current?.emit("joinConversation",t.id)}catch(s){console.error("Failed to fetch messages:",s),c([])}}},[a]);n.useEffect(()=>{(async()=>{S(!0);try{const r=(await b.get("/messages")).data.sort((d,u)=>{const D=new Date(d.updatedAt||0).getTime();return new Date(u.updatedAt||0).getTime()-D});w(r)}catch(s){console.error("Failed to fetch conversations:",s)}finally{S(!1)}})()},[o?.id]),n.useEffect(()=>{if(f&&x.length>0&&!a){const t=x.find(s=>s.id===f);t&&v(t)}},[f,x,a,v]),n.useEffect(()=>{if(h)return i.current=z("http://localhost:5000/api",{auth:{token:h}}),i.current.on("receiveMessage",t=>{t.conversationId===a?.id&&c(s=>[...s,t]),w(s=>{const r=[...s],d=r.findIndex(u=>u.id===t.conversationId);if(d>-1){const u={...r[d],messages:[t],updatedAt:t.createdAt};r.splice(d,1),r.unshift(u)}return r})}),i.current.on("userStatusChange",t=>{U(s=>{const r=new Map(s);return r.set(t.userId,t.isOnline),r}),B(s=>{const r=new Map(s);return r.set(t.userId,t.lastSeen),r})}),i.current.on("messageError",t=>{console.error("Message send error from server:",t),c(s=>s.filter(r=>!r.isOptimistic))}),()=>{i.current?.disconnect()}},[h,a?.id]),n.useEffect(()=>{A.current?.scrollIntoView({behavior:"smooth"})},[g]);const T=t=>{if(t.preventDefault(),!m.trim()||!a||!i.current||!o)return;const s={id:`optimistic-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,content:m,senderId:o.id,createdAt:new Date().toISOString(),sender:{id:o.id,profile:o.profile},isOptimistic:!0,conversationId:a.id};c(r=>[...r,s]),i.current.emit("sendMessage",{conversationId:a.id,content:m}),k("")},$=x.filter(t=>l(t)?.profile?.name?.toLowerCase().includes(C.toLowerCase())),O=n.useCallback(t=>{const s=I.get(t),r=L.get(t);return s?e.jsx("span",{className:"text-green-500 font-semibold",children:"Online"}):r?e.jsxs("span",{className:"text-gray-500 text-sm",children:["Last seen ",E(r)]}):e.jsx("span",{className:"text-gray-500 text-sm",children:"Offline"})},[I,L,E]);return e.jsx("div",{className:"max-w-7xl mx-auto h-[calc(100vh-8rem)] p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-xl h-full flex overflow-hidden relative",children:[e.jsxs("div",{className:`w-full md:w-1/3 md:flex flex-col transition-transform duration-300 ease-in-out absolute md:static inset-0 bg-white dark:bg-gray-800 z-20 ${a?"-translate-x-full md:translate-x-0":"translate-x-0"}`,children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-white",children:"Messages"}),e.jsxs("div",{className:"relative mt-4",children:[e.jsx("input",{type:"text",placeholder:"Search chats...",value:C,onChange:t=>R(t.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("div",{className:"absolute left-3 top-1/2 -translate-y-1/2",children:e.jsx(Y,{})})]})]}),e.jsx("div",{className:"flex-grow overflow-y-auto",children:M?e.jsx("p",{className:"text-center p-4 text-gray-500",children:"Loading..."}):$.length>0?$.map(t=>{const s=l(t);if(!s||!s.profile)return null;const r=t.messages&&t.messages[0];return e.jsxs("div",{onClick:()=>v(t),className:`flex items-center p-3 cursor-pointer transition-colors border-l-4 ${a?.id===t.id?"bg-blue-50 dark:bg-blue-900/50 border-blue-500":"border-transparent hover:bg-gray-50 dark:hover:bg-gray-700/50"}`,children:[e.jsx("img",{className:"h-12 w-12 rounded-full object-cover",src:p(s.profile),alt:`Avatar of ${s.profile?.name||"User"}`}),e.jsxs("div",{className:"flex-grow ml-4 min-w-0",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-gray-100 truncate",children:s.profile?.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 truncate",children:r?.content||"No messages yet"}),e.jsx("div",{className:"text-xs",children:s?.id&&O(s.id)})]})]},t.id)}):e.jsxs("div",{className:"text-center p-8 text-gray-500 dark:text-gray-400",children:[e.jsx("p",{children:"No conversations yet."}),e.jsx("p",{className:"text-sm mt-2",children:"You'll see your chats appear here once your mentorship request is accepted."}),o?.role==="MENTEE"&&e.jsxs("p",{className:"text-sm mt-2",children:[e.jsx(j,{to:"/mentors",className:"text-blue-500 hover:underline",children:"Find a mentor"})," ","to get started!"]}),o?.role==="MENTOR"&&e.jsx("p",{className:"text-sm mt-2",children:"Find a mentee to get started!"})]})})]}),e.jsx("div",{className:`w-full md:w-2/3 flex flex-col absolute md:static top-0 right-0 h-full bg-white dark:bg-gray-800 transition-transform duration-300 ease-in-out z-10 ${a?"translate-x-0":"translate-x-full md:translate-x-0"}`,children:a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700 flex items-center flex-shrink-0",children:[e.jsx("button",{onClick:()=>N(null),className:"p-1 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 md:hidden mr-2","aria-label":"Back to conversations",children:e.jsx(V,{})}),l(a)?.id&&e.jsxs(j,{to:`/users/${l(a)?.id}`,className:"flex items-center group",children:[e.jsx("img",{className:"h-10 w-10 rounded-full object-cover group-hover:ring-2 group-hover:ring-blue-500 transition-all",src:p(l(a)?.profile),alt:`Avatar of ${l(a)?.profile?.name||"User"}`}),e.jsxs("div",{className:"ml-4",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 dark:text-white group-hover:text-blue-500 transition-colors",children:l(a)?.profile?.name}),e.jsx("div",{className:"text-sm",children:l(a)?.id&&O(l(a).id)})]})]})]}),e.jsx("div",{className:"flex-grow p-6 overflow-y-auto bg-gray-50 dark:bg-gray-900",children:e.jsxs("div",{className:"space-y-2",children:[g.length===0&&!M?e.jsx("div",{className:"text-center text-gray-500",children:"No messages yet. Start a conversation!"}):g.map((t,s)=>e.jsxs("div",{className:`flex items-end gap-3 ${t.senderId===o?.id?"justify-end":"justify-start"}`,children:[t.senderId!==o?.id&&e.jsx("img",{src:p(l(a)?.profile),alt:"Sender",className:"h-8 w-8 rounded-full object-cover self-start"}),e.jsxs("div",{children:[e.jsx("div",{className:`rounded-2xl px-4 py-2 max-w-lg inline-block ${t.senderId===o?.id?"bg-blue-600 text-white rounded-br-none":"bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 shadow-sm rounded-bl-none"}`,children:e.jsxs("p",{className:"flex items-center",children:[t.content,t.senderId===o?.id&&!t.isOptimistic&&e.jsx(q,{})]})}),e.jsx("p",{className:`text-xs text-gray-400 mt-1 ${t.senderId===o?.id?"text-right":"text-left"}`,children:y(t.createdAt).format("h:mm A")})]})]},t.id||s)),e.jsx("div",{ref:A})]})}),e.jsx("div",{className:"p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex-shrink-0",children:e.jsxs("form",{onSubmit:T,className:"flex gap-4",children:[e.jsx("input",{type:"text",value:m,onChange:t=>k(t.target.value),placeholder:"Type a message...",className:"flex-grow px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white rounded-full p-3 hover:bg-blue-700 transition-transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500","aria-label":"Send message",children:e.jsx(W,{})})]})})]}):e.jsxs("div",{className:"hidden md:flex flex-col items-center justify-center h-full text-center text-gray-500 dark:text-gray-400",children:[e.jsx(Q,{}),e.jsx("h3",{className:"text-xl font-semibold mt-4",children:"Select a conversation"}),e.jsx("p",{children:"You'll see your chats appear here once your mentorship request is accepted."}),o?.role==="MENTEE"&&e.jsxs("p",{className:"text-sm mt-2",children:[e.jsx(j,{to:"/mentors",className:"text-blue-500 hover:underline",children:"Find a mentor"})," ","to get started!"]}),o?.role==="MENTOR"&&e.jsx("p",{className:"text-sm mt-2",children:"Find a mentee to get started!"})]})})]})})};export{K as default};
